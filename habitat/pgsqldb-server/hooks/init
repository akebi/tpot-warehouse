#!{{pkgPathFor "core/bash"}}/bin/bash -x

exec 2>&1


echo "Executing init hook"
source {{pkg.svc_config_path}}/helpers.sh

echo "Configure library path"
exec ldconfig {{cfg.libpath}}

create_db_superuser
# set_dir_permissions

if [ ! -d "{{cfg.db.datapath}}" ]; then
    setup_db_datapath

    # echo "Update postgresql.conf (database configurations)"
    # cp -v ${pkg.svc_config_path}/postgresql.conf {{pkg.svc_data_path}}/share
    
    # echo "Update pga_hba.conf (authorities definition)"
    # cp -v ${pkg.svc_config_path}/pga_hba.conf {{pkg.svc_data_path}}/share
   
    echo "Database does not exist, initializing with 'initdb'"
    exec chpst -U {{cfg.superuser.name}} -u {{cfg.superuser.name}} \
	{{cfg.binpath}}/initdb -U {{cfg.superuser.name}} -E utf8 \
			-D {{cfg.db.datapath}} --locale POSIX \
                	--data-checksums
fi

echo "Checking status"
exec chpst -U {{cfg.superuser.name}} -u {{cfg.superuser.name}} \
	{{cfg.binpath}}/pg_ctl status
